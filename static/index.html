<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>è·å–ä½“é‡ä¿¡æ¯</title>
    <link rel="stylesheet" href="./bootstrap.min.css">

    <!-- å¼•å…¥Bootstrap CSS -->
    <link rel="stylesheet" href="./bootstrap.min.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">


    <style>
        /* åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„CSSæ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            text-align: center;
            font-size: 1.5em;
            margin: 0;
            margin-top: 1em;
        }

        h3 {
            color: #000000;
            text-shadow: 0px 0px 16px #ffe476;
        }

        .margin-top-20px {
            margin-top: 20px;
        }

        footer {
            --mask:
                radial-gradient(22.36px at 50% 30.00px, #000 99%, #0000 101%) calc(50% - 20px) 0/40px 100%,
                radial-gradient(22.36px at 50% -20px, #0000 99%, #000 101%) 50% 10px/40px 100% repeat-x;
            -webkit-mask: var(--mask);
            mask: var(--mask);
            background-color: #ffe6b1;
            padding-top: 20px;
            padding-bottom: 10px;
            text-align: center;
            font-size: 0.8em;
        }

        .language-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .language-switcher .dropdown-menu {
            min-width: 5rem;
        }
    </style>

</head>

<body>
    <img
      src="https://img.99danji.com/uploadfile/2022/0705/20220705045433732.png"
      alt="å¥½è½» logo"
      style="width: 50"
    />
    <div class="container mt-3">
        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ•°æ® -->
        <h3 id="generate-data-title">ç”Ÿæˆæ•°æ®</h3>
        <form>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1"><i class="fa fa-user"></i></span>
                    </div>
                    <input type="text" class="form-control" id="account" placeholder="è¯·è¾“å…¥å¥½è½»è´¦å·ï¼ˆæ‰‹æœºå·ï¼‰"
                        aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon2"><i class="fa fa-lock"></i></span>
                    </div>
                    <input type="password" class="form-control" id="password" placeholder="è¯·è¾“å…¥å¥½è½»å¯†ç "
                        aria-describedby="basic-addon2">
                </div>
            </div>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3"><i class="fa fa-ruler-vertical"></i></span>
                    </div>
                    <input type="text" class="form-control" id="height" placeholder="è¯·è¾“å…¥èº«é«˜ï¼ˆç±³ï¼‰ï¼Œå¦‚ï¼šâ€œ1.8â€ï¼Œç”¨äºBMIèŒƒå›´è®¡ç®—"
                        aria-describedby="basic-addon3">
                </div>
            </div>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon4"><i class="fa fa-signature"></i></span>
                    </div>
                    <input type="text" class="form-control" id="nickname" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆç”¨äºæ–‡ä»¶ç”Ÿæˆï¼‰"
                        aria-describedby="basic-addon4">
                </div>
            </div>


            <button id="run-script" class="btn btn-primary mt-3">è·å–å¥½è½»ä½“é‡</button>
        </form>
        <div id="file-list-container" class="mt-3">
        </div>
        <div id="map-container" class="mt-3"></div>
    </div>

    <hr>

    <h3 id="search-data-title">æŸ¥è¯¢æ•°æ®</h3>
    <div class="form-group">

        <div class="col-12 col-md-10 mx-auto"></div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="search-account" placeholder="è¯·åœ¨ç”Ÿæˆåï¼Œå†è¾“å…¥æ‰‹æœºå·è¿›è¡ŒæŸ¥è¯¢â€¦â€¦">
        </div>
    </div>
    <button id="search-files" class="btn btn-primary margin-top-20px">æŸ¥è¯¢</button>
    <button id="download-files" class="btn btn-success margin-top-20px" style="display: none;"
        onclick="downloadFile()">ä¸‹è½½æ–‡ä»¶</button>
    <button id="delete-files" class="btn btn-danger margin-top-20px" style="display: none;"
        onclick="confirmDelete()">åˆ é™¤</button>
    </div>
    <div id="search-list-container" class="mt-3"></div>
    <div id="map-container2" class="mt-3"></div>
    </div>


    <script>
        document.getElementById('run-script').addEventListener('click', function () {
            const runScriptButton = document.getElementById('run-script');
            const account = document.getElementById('account').value.trim();
            const password = document.getElementById('password').value;
            const nickname = document.getElementById('nickname').value;
            const height = document.getElementById('height').value;
            // æ£€æŸ¥æœç´¢æ¡†å†…å®¹æ˜¯å¦ä¸ºç©º
            if (account === '' || password === ''|| nickname === ''|| height === '') {
                alert('è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯');
                return; // å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºå¹¶é€€å‡ºå‡½æ•°
            }
            // ç¦ç”¨æŒ‰é’®å¹¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬
            runScriptButton.disabled = true;
            runScriptButton.textContent = 'ç”Ÿæˆä¸­â€¦â€¦';

            fetch('/run-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `account=${encodeURIComponent(account)}&password=${encodeURIComponent(password)}&nickname=${encodeURIComponent(nickname)}&height=${encodeURIComponent(height)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        setTimeout(() => {
                            fetch('/list-files', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `account=${encodeURIComponent(account)}`
                            })
                                .then(response => response.json())
                                .then(files => {
                                    const fileListContainer = document.getElementById('file-list-container');
                                    const mapContainer = document.getElementById('map-container');
                                    fileListContainer.innerHTML = ''; // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å®¹å™¨
                                    mapContainer.innerHTML = ''; // æ¸…ç©ºåœ°å›¾å®¹å™¨
                                    files.forEach(file => {
                                        const fileLink = document.createElement('a');
                                        fileLink.href = `/static/result/${file}`; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                                        fileLink.textContent = file;
                                        fileLink.target = '_blank'; // åœ¨æ–°çª—å£ä¸­æ‰“å¼€
                                        fileListContainer.appendChild(fileLink);
                                        fileListContainer.appendChild(document.createElement('br'));
                                    });
                                     // å‡è®¾ files æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä½ æƒ³è¦åœ¨ iframe ä¸­å±•ç¤ºçš„æ–‡ä»¶è·¯å¾„
                                    const filePath = files[0]; // æˆ–è€…æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–‡ä»¶è·¯å¾„

                                    // åˆ›å»º iframe å…ƒç´ å¹¶è®¾ç½®å…¶å±æ€§
                                    const iframe = document.createElement('iframe');
                                    iframe.src = `/static/result/${account}_weight.html`; // è®¾ç½® iframe çš„ src å±æ€§
                                    iframe.width = '100%'; // è®¾ç½® iframe çš„å®½åº¦
                                    iframe.height = '600'; // è®¾ç½® iframe çš„é«˜åº¦
                                    iframe.frameBorder = '0'; // å¯é€‰ï¼šç§»é™¤ iframe è¾¹æ¡†

                                    // å°† iframe æ·»åŠ åˆ° map-container ä¸­
                                    mapContainer.appendChild(iframe);
                                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                                    runScriptButton.disabled = false;
                                    runScriptButton.textContent = 'è·å–å¥½è½»ä½“é‡';
                                });
                        });
                        alert('æç¤ºï¼š\n' + data.output);
                    } else {
                        alert('æç¤ºï¼š\n' + data.output);
                        // å¦‚æœå¤±è´¥ï¼Œä¹Ÿæ¢å¤æŒ‰é’®çŠ¶æ€
                        runScriptButton.disabled = false;
                        runScriptButton.textContent = 'è·å–å¥½è½»ä½“é‡';
                    }
                }).catch(error => {
                    // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰é—®é¢˜
                    alert('å‘ç”Ÿé”™è¯¯ï¼š\n' + error);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    runScriptButton.disabled = false;
                    runScriptButton.textContent = 'è·å–å¥½è½»ä½“é‡';
                });
        });


        document.getElementById('search-files').addEventListener('click', function () {
            const searchAccount = document.getElementById('search-account').value.trim(); // ä½¿ç”¨trim()å»é™¤ä¸¤ç«¯ç©ºç™½å­—ç¬¦

            // æ£€æŸ¥æœç´¢æ¡†å†…å®¹æ˜¯å¦ä¸ºç©º
            if (searchAccount === '') {
                alert('è¯·è¾“å…¥è´¦å·');
                return; // å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºå¹¶é€€å‡ºå‡½æ•°
            }

            // ç¦ç”¨æŸ¥è¯¢æŒ‰é’®å¹¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬
            const searchButton = document.getElementById('search-files');
            searchButton.disabled = true;
            searchButton.textContent = 'æŸ¥è¯¢ä¸­â€¦â€¦';

            // å‘é€æŸ¥è¯¢è¯·æ±‚
            fetch('/list-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `account=${encodeURIComponent(searchAccount)}`
            })
                .then(response => response.json())
                .then(files => {
                    const searchListContainer = document.getElementById('search-list-container');
                    searchListContainer.innerHTML = ''; // æ¸…ç©ºæœç´¢ç»“æœå®¹å™¨
                    const mapContainer2 = document.getElementById('map-container2');
                    searchListContainer.innerHTML = ''; // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å®¹å™¨
                    mapContainer2.innerHTML = ''; // æ¸…ç©ºåœ°å›¾å®¹å™¨
                    // è¿‡æ»¤å‡ºå®Œå…¨åŒ¹é…è´¦å·çš„æ–‡ä»¶
                    const matchedFiles = files.filter(file =>
                        file.startsWith(`${searchAccount}_`)
                    );

                    if (matchedFiles.length === 0) {
                        // å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºâ€œæ— æŸ¥è¯¢ç»“æœâ€
                        searchListContainer.textContent = '"' + searchAccount + '"è´¦å·æœªæŸ¥è¯¢åˆ°ä½“é‡ä¿¡æ¯ï¼Œè¯·ç”Ÿæˆæ•°æ®ã€‚';
                    } else {
                        // å¦‚æœæœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºé“¾æ¥
                        matchedFiles.forEach(file => {
                            const fileLink = document.createElement('a');
                            fileLink.href = `/static/result/${file}`; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                            fileLink.textContent = file;
                            fileLink.target = '_blank'; // åœ¨æ–°çª—å£ä¸­æ‰“å¼€
                            searchListContainer.appendChild(fileLink);
                            searchListContainer.appendChild(document.createElement('br'));
                        });
                        // å¦‚æœæœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        document.getElementById('download-files').style.display = 'inline-block';
                        document.getElementById('delete-files').style.display = 'inline-block';

                        // å‡è®¾ files æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä½ æƒ³è¦åœ¨ iframe ä¸­å±•ç¤ºçš„æ–‡ä»¶è·¯å¾„
                    const filePath = files[0]; // æˆ–è€…æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–‡ä»¶è·¯å¾„

                    // åˆ›å»º iframe å…ƒç´ å¹¶è®¾ç½®å…¶å±æ€§
                    const iframe = document.createElement('iframe');
                    iframe.src = `/static/result/${searchAccount}_weight.html`; // è®¾ç½® iframe çš„ src å±æ€§
                    iframe.width = '100%'; // è®¾ç½® iframe çš„å®½åº¦
                    iframe.height = '600'; // è®¾ç½® iframe çš„é«˜åº¦
                    iframe.frameBorder = '0'; // å¯é€‰ï¼šç§»é™¤ iframe è¾¹æ¡†

                    // å°† iframe æ·»åŠ åˆ° map-container ä¸­
                    mapContainer2.appendChild(iframe);
                    }
                    
                    // æ¢å¤æŸ¥è¯¢æŒ‰é’®çŠ¶æ€
                    searchButton.disabled = false;
                    searchButton.textContent = 'æŸ¥è¯¢';
                }).catch(error => {
                    // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰é—®é¢˜
                    alert('å‘ç”Ÿé”™è¯¯ï¼š\n' + error);
                    // æ¢å¤æŸ¥è¯¢æŒ‰é’®çŠ¶æ€
                    searchButton.disabled = false;
                    searchButton.textContent = 'æŸ¥è¯¢';
                });
        });


        function downloadFile() {
            // è·å–è¾“å…¥æ¡†ä¸­çš„è´¦å·
            var account = document.getElementById('search-account').value;
            // å¦‚æœè´¦å·éç©ºï¼Œåˆ™æ‹¼æ¥æ–‡ä»¶è·¯å¾„å¹¶è§¦å‘ä¸‹è½½
            if (account) {
                var filePath = './' + encodeURIComponent(account) + '_weight.zip';
                // åˆ›å»ºä¸€ä¸ªaæ ‡ç­¾ç”¨äºä¸‹è½½
                var downloadLink = document.createElement('a');
                downloadLink.href = filePath;
                downloadLink.download = account + '_weight.zip';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } else {
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œåˆ™å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æç¤ºç”¨æˆ·è¾“å…¥è´¦å·çš„ä»£ç 
                alert('è¯·è¾“å…¥è´¦å·è¿›è¡ŒæŸ¥è¯¢');
            }
        }

        function confirmDelete() {
            var account = document.getElementById('search-account').value;
            if (account) {
                var confirmResponse = confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰' + account + 'çš„æ•°æ®å—ï¼Ÿ');
                if (confirmResponse) {
                    // ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®šï¼Œå‘é€è¯·æ±‚åˆ°Flaskåç«¯è¿›è¡Œåˆ é™¤æ“ä½œ

                    fetch('/delete-endpoint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `account=${encodeURIComponent(account)}`
                    })
                        .then(response => response.json())
                        .then(data => {
                            // å¤„ç†å“åº”æ•°æ®
                            console.log(data);
                            var messageContainer = document.getElementById('message-container');
                            if (data.success) {
                                alert('åˆ é™¤æˆåŠŸã€‚' + (data.output || ''));
                            } else {
                                alert('åˆ é™¤å¤±è´¥ï¼š' + (data.output || ''));
                            }
                            location.reload();
                        })
                        .catch((error) => {
                            // å¤„ç†è¯·æ±‚é”™è¯¯
                            console.error('Error:', error);
                            alert('è¯·æ±‚é”™è¯¯ï¼š' + error);
                            // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿåˆ·æ–°é¡µé¢
                            location.reload();
                        });
                } else {
                    // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                }
            } else {
                alert('è¯·è¾“å…¥è´¦å·è¿›è¡ŒæŸ¥è¯¢');
            }
        }


    </script>
    <script src="./bootstrap.min.js"></script>
    <script src="./bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="./bootstrap.min.js"></script>

    <!-- åœ¨ä½ çš„HTMLæ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªfooteréƒ¨åˆ† -->
    <footer>
        <p>ğŸ›ˆæœ¬é¡¹ç›®ä¸å¥½è½»å®˜æ–¹æ— å…³ï¼ä¸”æœ¬ç½‘ç«™ä¸ä¼šå­˜å‚¨ä½ çš„ä¸ªäººè´¦å·ã€å¯†ç ï¼Œåªä¼šç”¨äºä¸ªäººæ•°æ®çš„ç”Ÿæˆã€‚</p>
        <p>å¦‚æœä¸å†éœ€è¦ï¼Œå»ºè®®ç”Ÿæˆååˆ é™¤ä¸ªäººæ–‡ä»¶ã€‚</p>
        <div class="text-center p-3">
            ç”±<a class="text-dark fab fa-github" href="https://github.com/arthurfsy2/yunmai_weight_extract2json"
                target="_blank">arthurfsy2/yunmai_weight_extract2json</a>æä¾›æ”¯æŒ
        </div>
    </footer>
</body>

</html>